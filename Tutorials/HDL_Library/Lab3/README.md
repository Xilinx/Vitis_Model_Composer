# Lab 3: Timing and Resource Analysis

In this lab, you learn how to verify the functionality of your designs by simulating in Simulink¬Æ to ensure that your Vitis Model Composer design is correct when you implement the design in your target Xilinx¬Æ device.

### Objectives
After completing this lab, you will be able to:
 * Identify timing issues in the HDL files generated by Vitis Model Composer and discover the source of the timing violations in your design.
 * Perform resource analysis and access the existing resource analysis results, along with recommendations to optimize.

### Procedure 
This lab has two primary parts:
 * In Step 1 you will learn how to do timing analysis in Vitis Model Composer.
 * In Step 2 you will learn how to perform resource analysis in Vitis Model Composer.

## Step 1: Timing Analysis in Vitis Model Composer

1. Invoke Vitis Model Composer.
    - On Windows systems select **Windows > Xilinx Design Tools > Vitis Model Composer 2022.2.**
    - On Linux systems, type `model_composer` at the command prompt.

2. Navigate to the Lab3 folder: <samp>\HDL_Library\Lab3.</samp>
<br><br>You can view the directory contents in the MATLAB¬Æ Current Folder browser, or type ls at the command line prompt.

3. Open the Lab3 design using one of the following:
    - At the MATLAB command prompt, type open `Lab3.slx`
    - Double-click Lab3.slx in the Current Folder browser.
<br><br> The Lab3 design opens, as shown in the following figure.
<br><br><img src="Images/Step1/Part1/Step3.png">
Note that this design differs from the previous labs in that all of the HDL blocks are placed inside a subsystem (**HDL_DUT**) while the Vitis Model Composer Hub block remains at the top level of the model. Going forward, this is a recommended approach for architecting your model using Vitis Model Composer.

4. From the Simulink Toolstrip, click the Run button to simulate the design.
> üìù **Note**:  In order to see accurate results from Resource Analyzer Window it is recommended to specify a new target directory rather than use the current working directory.

5. Double-click the **Vitis Model Composer Hub** block to open the Properties Editor.

6. Select the **HDL_DUT** subsystem on the left, then the **HDL Analysis** tab.

7. From the Perform Analysis menu, select **Post Synthesis** and from Analyzer type menu select **Timing** as shown in the following figure.
<br><br><img src="Images/Step1/Part1/Step7.png">

8. In the Model Composer Hub dialog box, click Generate.
<br><br>When you generate, the following occurs:
    - Vitis Model Composer generates the required files for the selected compilation target. For timing analysis Vitis Model Composer invokes Vivado in the background for the design project, and passes design timing constraints to Vivado.
    - Depending on your selection for Perform Analysis (Post Synthesis or Post Implementation), the design runs in Vivado through synthesis or through implementation.
    - After the Vivado tools run is completed, timing paths information is collected and saved in a specific file format from the Vivado timing database.
    - Vitis Model Composer processes the timing information and displays a Timing Analyzer table with timing paths information as shown in the following figure.
<br><br><img src="Images/Step1/Part1/Step8.png">

9. In the timing analyzer table:
    - Paths with lowest slack values display, with the worst slack showing at the top and increasing toward the bottom.
    - Paths with timing violations have a negative slack and display in red.

10. Cross probe from the Timing Analyzer table to the Simulink model by clicking any path in the Timing Analyzer table, which highlights the corresponding Vitis Model Composer HDL blocks in the model. This allows you to troubleshoot timing violations by analyzing the path on which they occur.

11. When you cross probe, you see the corresponding path as shown in the following figure.

12. Blocks with timing violations are highlighted in red.
<br><br><img src="Images/Step1/Part1/Step12.png">

13. Double-click the second path in the Timing Analyzer table and cross-probe, the corresponding highlighted path in green which indicates no timing violation.
<br><br><img src="Images/Step1/Part1/Step13-1.png">
<br><br> If you close the Timing Analyzer sometime later you might want to relaunch the Timing Analyzer table using the existing timing analyzer results for the model. A Launch button is provided under the HDL Analysis tab of the Model Composer Hub dialog box. This will only work if you already ran timing analysis on the Simulink model.
<br><br><img src="Images/Step1/Part1/Step13-2.png">

> üìù **Note**: If you relaunch the Timing Analyzer window, make sure that the Analysis Type field is set to Timing. The table that opens will display the results stored in the Code Directory specified in the Model Composer Hub dialog box, regardless of the option selected for Perform Analysis (Post Synthesis or Post Implementation).

### Troubleshooting Timing Violations

Inserting some registers in the combinational path might give better timing results and might help overcome timing violations if any. This can be done by changing latency of the combinational blocks as explained in the following.

1. Click the violated path from the Timing Analyzer window which opens the violated path as shown in the following figure.
<br><br><img src="Images/Step1/Part2/Step1.png">

2. Double-click the coef block to open the Single Port RAM block parameters window as shown in the following figure.
<br><br><img src="Images/Step1/Part2/Step2.png">

3. Under Basic tab, change the latency from 1 to 2 and click **OK**.

4. Double-click the **Model Composer Hub** block, ensure that the Analyzer Type is Timing and click **Generate**.

5. After the generation completes, it opens the timing Analyzer table as shown in the following figure. Observe the status pass at the top-right corner. It indicates there are no timing violated paths in the design.
<br><br><img src="Images/Step1/Part2/Step5.png">

> üìù **Note**: <br>
> a. For quicker timing analysis iterations, post-synthesis analysis is preferred over post-implementation analysis. <br>
> b. Changing the latency of the block might increase the number of resources which can be seen using Step 2: Resource Analysis in Vitis Model Composer.


## Step 2: Resource Analysis in Vitis Model Composer

In this step we use same design, <samp>Lab3.slx</samp>, used for Step 1 but we are going to perform Resource Analysis.

> ‚≠ê **Tip**: Resource Analysis can be performed whenever you generate any of the following compilation types: <br>
> * IP catalog <br>
> * Hardware Co-Simulation <br>
> * Synthesized Checkpoint <br>
> * HDL Netlist <br>

1. Double-click the **Model Composer Hub** block in the Simulink model. On the HDL Settings tab, ensure that one of the Compilation Types listed above is selected.

> üìù **Note**: In order to see accurate results from Resource Analyzer Window it is recommended to specify a new target directory rather than use the current working directory.

2. In the HDL Analysis tab, set the Perform Analysis field to **Post Synthesis** and Analysis Type type field to **Resource**.
<br><br><img src="Images/Step2/Step2.png">

3. In the Model Composer Hub dialog box, click **Generate**
<br><br>Model Composer processes the resource utilization data and displays a Resource Analyzer window with resource utilization information.
<br><br><img src="Images/Step2/Step3.png">
<br><br>Each column heading (for example, BRAMs, DSPs, or LUTs) in the window shows the total number of each type of resources available in the Xilinx device for which you are targeting your design. The rest of the window displays a hierarchical listing of each subsystem and block in the design, with the count of these resource types.

4. You can cross probe from the Resource Analyzer window to the Simulink model by clicking a block or subsystem name in the Resource Analyzer window, which highlights the corresponding Vitis Model Composer HDL block or subsystem in the model.
<br><br>Cross probing is useful to identify blocks and subsystems that are implemented using a particular type of resource.

5. The block you have selected in the window will be highlighted yellow and outlined in red.
<!-- <br><br><img src="Images/Step2/Step5.png"> -->

6. If the block or subsystem you have selected in the window is within an upper-level subsystem, then the parent subsystem is highlighted in red in addition to the underlying block as shown in the following figure.
<br><br><img src="Images/Step2/Step6.png">

> ‚ùó‚ùó **Important**: If the Resource Analyzer window or the Timing Analyzer window opens and no information is displayed in the window (table cells are empty), double-click the Model Composer Hub block and set the Code Directory to a new directory, that is, a directory that has not been used before. Then run the analysis again.


## Summary

In this lab you learned how to use timing and resource analysis inside Model Composer which, in turn, invokes Vivado synthesis to collect the information for the analysis. You also learned how to identify timing violated paths and to troubleshoot them for simple designs.

--------------
Copyright 2022 Xilinx

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
